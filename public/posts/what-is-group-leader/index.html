<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>group leaderäºŒä¸‰äº‹ - /home/adelzhang</title><meta name="Description" content="This is my cool site"><meta property="og:title" content="group leaderäºŒä¸‰äº‹" />
<meta property="og:description" content="I. group leaderåœ¨å“ª æœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥å‘ç°group leaderçš„è¸ªè¿¹ï¼Œæ¯”å¦‚åœ¨applicationæ¨¡å—ä¸­ã€‚é€šå¸¸æˆ‘ä»¬è°ƒç”¨application:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://adelzhang.github.io/posts/what-is-group-leader/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2014-09-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2014-09-20T00:00:00+00:00" /><meta property="og:site_name" content="My cool site" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="group leaderäºŒä¸‰äº‹"/>
<meta name="twitter:description" content="I. group leaderåœ¨å“ª æœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥å‘ç°group leaderçš„è¸ªè¿¹ï¼Œæ¯”å¦‚åœ¨applicationæ¨¡å—ä¸­ã€‚é€šå¸¸æˆ‘ä»¬è°ƒç”¨application:"/>
<meta name="application-name" content="My cool site">
<meta name="apple-mobile-web-app-title" content="My cool site"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://adelzhang.github.io/posts/what-is-group-leader/" /><link rel="prev" href="https://adelzhang.github.io/posts/remote-and-local-call-in-erlang/" /><link rel="next" href="https://adelzhang.github.io/posts/may-be-a-escript-bug/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css"></noscript><link rel="preload" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "group leaderäºŒä¸‰äº‹",
        "inLanguage": "zh-cn",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/adelzhang.github.io\/posts\/what-is-group-leader\/"
        },"genre": "posts","keywords": "erlang","wordcount":  1739 ,
        "url": "https:\/\/adelzhang.github.io\/posts\/what-is-group-leader\/","datePublished": "2014-09-20T00:00:00+00:00","dateModified": "2014-09-20T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "adelzhang"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="/home/adelzhang"><span class="header-title-pre">ğŸ˜˜</span>/home/adelzhang</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> æ–‡ç«  </a><a class="menu-item" href="/tags/"> æ ‡ç­¾ </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="/home/adelzhang"><span class="header-title-pre">ğŸ˜˜</span>/home/adelzhang</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="">æ–‡ç« </a><a class="menu-item" href="/tags/" title="">æ ‡ç­¾</a><a href="javascript:void(0);" class="menu-item theme-switch" title="åˆ‡æ¢ä¸»é¢˜">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">ç›®å½•</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">group leaderäºŒä¸‰äº‹</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="http://adelzhang.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>adelzhang</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2014-09-20">2014-09-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;çº¦ 1739 å­—&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;é¢„è®¡é˜…è¯» 4 åˆ†é’Ÿ&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>ç›®å½•</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#i-group-leaderåœ¨å“ª">I. group leaderåœ¨å“ª</a></li>
    <li><a href="#ii-ä»€ä¹ˆæ˜¯group-leader">II. ä»€ä¹ˆæ˜¯group leader</a></li>
    <li><a href="#iii-ä½•æ—¶éœ€è¦group-leader">III. ä½•æ—¶éœ€è¦group leader</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="i-group-leaderåœ¨å“ª">I. group leaderåœ¨å“ª</h2>
<p>æœ‰å¾ˆå¤šåœ°æ–¹å¯ä»¥å‘ç°group leaderçš„è¸ªè¿¹ï¼Œæ¯”å¦‚åœ¨<code>application</code>æ¨¡å—ä¸­ã€‚é€šå¸¸æˆ‘ä»¬è°ƒç”¨<code>application:start(Application)</code>æ¥å¯åŠ¨åº”ç”¨ï¼Œ<code>application</code>
æ˜¯å¯¹<code>application_controller</code>çš„å°è£…ï¼š</p>
<pre><code>start(Application, RestartType) -&gt;
    case load(Application) of
        ok -&gt;
            Name = get_appl_name(Application),
            application_controller:start_application(Name, RestartType);
        {error, {already_loaded, Name}} -&gt;
            application_controller:start_application(Name, RestartType);
        Error -&gt;
            Error
    end.
</code></pre>
<p><code>application_controller</code>æ˜¯ä¸€ä¸ªä»¿é€ çš„OTPè¿›ç¨‹ï¼ˆä¸ºä»€ä¹ˆè¦ä»¿é€ ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨gen_serveræˆ–è€…proc_libå‘¢ï¼Ÿï¼‰:</p>
<pre><code>start(KernelApp) -&gt;
    Init = self(),
    AC = spawn_link(fun() -&gt; init(Init, KernelApp) end),
    ...

init(Init, KernelApp) -&gt;
    register(?AC, self()),
    process_flag(trap_exit, true),
    put('$ancestors', [Init]), % OTP-5811, for gen_server compatibility
    put('$initial_call', {application_controller, start, 1}),
    ...
</code></pre>
<p><code>application_controller</code>ç¡®ä¿Applicationçš„æ‰€æœ‰ä¾èµ–åº”ç”¨éƒ½å·²å¯åŠ¨ï¼Œå¦åˆ™è¿”å›<code>{error, {not_started, App}}</code>ï¼Œå…¶ä¸­Appæ˜¯æ²¡æœ‰å¯åŠ¨çš„ä¾èµ–åº”ç”¨ã€‚åœ¨
ä¸€ä¸ªæ–°å»ºè¿›ç¨‹ï¼ˆä¸ºä»€ä¹ˆè¦åœ¨æ–°è¿›ç¨‹ä¸­ï¼Ÿï¼‰ï¼Œåˆ›å»ºå±äºApplicationçš„application masterè¿›ç¨‹:</p>
<pre><code>handle_call({start_application, AppName, RestartType}, From, S) -&gt;
    ...
    case catch check_start_cond(AppName, RestartType, Started, Running) of
        {ok, Appl} -&gt;
             spawn_starter(From, Appl, S, normal),
             {noreply, S#state{starting = [{AppName, RestartType, normal, From} |
                                            Starting],
                               start_req = [{AppName, From} | Start_req]}};
        {error, _R} = Error -&gt;
            {reply, Error, S}
    end,
    ...

spawn_starter(From, Appl, S, Type) -&gt;
    spawn_link(?MODULE, init_starter, [From, Appl, S, Type]).

init_starter(_From, Appl, S, Type) -&gt;
    process_flag(trap_exit, true),
    AppName = Appl#appl.name,
    gen_server:cast(?AC, {application_started, AppName, 
              catch start_appl(Appl, S, Type)}).

start_appl(Appl, S, Type) -&gt;
    ...
    application_master:start_link(ApplData, Type),
    ...
</code></pre>
<p>group leaderé©¬ä¸Šå°±è¦å‡ºç°äº†ã€‚application masteræ˜¯Applicationçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒä¼šè°ƒç”¨Application behaviourå›è°ƒå‡½æ•°<code>Module:start/2</code>:</p>
<pre><code>start_link(ApplData, Type) -&gt;
    Parent = whereis(application_controller),
    proc_lib:start_link(application_master, init,
            [Parent, self(), ApplData, Type]). 
</code></pre>
<p>åœ¨<code>init</code>å‡½æ•°å‰çš„ä¸€æ®µæ³¨é‡Šä¸­ï¼Œæè¿°äº†AM(application master)æ˜¯å¦‚ä½•å¯åŠ¨åº”ç”¨çš„:</p>
<pre><code>%%%-----------------------------------------------------------------
%%% The logical and physical process structrure is as follows:
%%%
%%%         logical                physical
%%%
%%%         --------               --------
%%%         |AM(GL)|               |AM(GL)|               
%%%         --------               -------- 
%%%            |                       |
%%%         --------               --------
%%%         |Appl P|               |   X  |
%%%         --------               --------
%%%                                    |
%%%                                --------
%%%                                |Appl P|
%%%                                --------
%%%
%%% Where AM(GL) == Application Master (Group Leader)
%%%       Appl P == The application specific root process (child to AM)
%%%       X      == A special 'invisible' process
%%% The reason for not using the logical structrure is that
%%% the application start function is synchronous, and 
%%% that the AM is GL.  This means that if AM executed the start
%%% function, and this function uses spawn_request/1
%%% or io, deadlock would occur.  Therefore, this function is
%%% executed by the process X.  Also, AM needs three loops;
%%% init_loop (waiting for the start function to return)
%%% main_loop
%%% terminate_loop (waiting for the process to die)
%%% In each of these loops, io and other requests are handled.

init(Parent, Starter, ApplData, Type) -&gt;
    link(Parent),
    process_flag(trap_exit, true),
    OldGleader = group_leader(),
    group_leader(self(), self()),
    ...
</code></pre>
<p>group leaderç»ˆäºå‡ºç°äº†ï¼Œé‚£ä¹ˆç–‘é—®å°±å˜æˆï¼šä»€ä¹ˆæ˜¯group leaderï¼Ÿä¸ºä»€ä¹ˆAMä¸é‡‡ç”¨è¾…åŠ©è¿›ç¨‹çš„è¯ä¼šé€ æˆdeadlockï¼Ÿ</p>
<h2 id="ii-ä»€ä¹ˆæ˜¯group-leader">II. ä»€ä¹ˆæ˜¯group leader</h2>
<p>åœ¨erlang docä¸­ï¼Œæœ‰å…³group leaderæ˜¯è¿™æ ·æè¿°çš„ï¼š</p>
<pre><code>Every process is a member of some process group and all groups have a group leader. 
All IO from the group is channeled to the group leader. 
When a new process is spawned, it gets the same group leader as the spawning process. 
Initially, at system start-up, init is both its own group leader and the group leader of all processes.
</code></pre>
<p><code>group_leader()</code>å¯ä»¥è¿”å›å½“å‰è¿›ç¨‹çš„group leaderï¼Œ<code>group_leader(GL, Pid)</code>ä¿®æ”¹Pidè¿›ç¨‹çš„GLã€‚</p>
<p>ä»¥io:format/0ä¸ºä¾‹ï¼Œçœ‹çœ‹group leaderæ€ä¹ˆå‘æŒ¥ä½œç”¨ã€‚io:formatä¼šå‘GLå‘é€æ¶ˆæ¯ï¼Œå¹¶ä¸”ç­‰å¾…GLè¿”å›ã€‚è¿™ä¹Ÿè§£é‡Šäº†AMä¸é‡‡ç”¨
è¾…åŠ©è¿›ç¨‹çš„è¯å¯èƒ½é€ æˆdeadlockçš„åŸå› ã€‚</p>
<pre><code>format(Format, Args) -&gt;
    format(default_output(), Format, Args).

default_output() -&gt;
    group_leader().

format(Io, Format, Args) -&gt;
    o_request(Io, {format,Format,Args}, format).

o_request(Io, Request, Func) -&gt;
    ...
    request(Io, Request)
    ...

request(Pid, Request) when is_pid(Pid) -&gt;
    execute_request(Pid, io_request(Pid, Request)),
    ...

execute_request(Pid, {Convert,Converted}) -&gt;
    Pid ! {io_request,self(),Pid,Converted},
    ...
    wait_io_mon_reply(Pid, Mref),
    ...

wait_io_mon_reply(From, Mref) -&gt;
    receive
        {io_reply, From, Reply} -&gt;
            erlang:demonitor(Mref, [flush]),
            Reply;
        {'EXIT', From, _What} -&gt;
            receive
                {'DOWN', Mref, _, _, _} -&gt; true
            after 0 -&gt; true
            end,
            {error,terminated};
        {'DOWN', Mref, _, _, _} -&gt;
            receive
                {'EXIT', From, _What} -&gt; true
            after 0 -&gt; true
            end,
            {error,terminated}
    end.
</code></pre>
<h2 id="iii-ä½•æ—¶éœ€è¦group-leader">III. ä½•æ—¶éœ€è¦group leader</h2>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸ç”¨å…³å¿ƒgroup leaderã€‚ä½†åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¯èƒ½éœ€è¦å¯¹ioè¿›è¡Œæ‹¦æˆªï¼Œè¿™æ—¶å€™å°±
éœ€è¦ä¿®æ”¹è¿›ç¨‹çš„group leaderã€‚rpcæ¨¡å—å°±åˆ©ç”¨äº†è¿™ç§æŠ€æœ¯ï¼Œä½¿å¾—åœ¨è¿œç¨‹èŠ‚ç‚¹è¿è¡Œçš„ä»£ç ï¼Œç»“æœè¾“å‡º
åœ¨æœ¬åœ°èŠ‚ç‚¹ã€‚æœ¬åœ°nodeè°ƒç”¨rpcæ—¶ï¼Œgroup_leader()æ˜¯å‚æ•°ä¹‹ä¸€ã€‚è¿œç¨‹node spawnä¸€ä¸ªæ–°è¿›ç¨‹æ¥æ‰§è¡Œ
rpcï¼Œå¹¶å°†è¯¥è¿›ç¨‹GLä¿®æ”¹ä¸ºæœ¬åœ°nodeæé«˜çš„group_leader()ï¼Œä»è€Œå®ç°ioçš„æ‹¦æˆªã€‚</p>
<pre><code>%% code snippet of rpc.erl

call(N,M,F,A) when node() =:= N -&gt;  %% Optimize local call
    local_call(M, F, A);
call(N,M,F,A) -&gt;
    do_call(N, {call,M,F,A,group_leader()}, infinity).

do_call(Node, Request, infinity) -&gt;
    rpc_check(catch gen_server:call({?NAME,Node}, Request, infinity));

handle_call({call, Mod, Fun, Args, Gleader}, To, S) -&gt;
    handle_call_call(Mod, Fun, Args, Gleader, To, S);

handle_call_call(Mod, Fun, Args, Gleader, To, S) -&gt;
    RpcServer = self(),
    %% Spawn not to block the rpc server.
    {Caller,_} =
    erlang:spawn_monitor(
      fun () -&gt;
          set_group_leader(Gleader),
          Reply = 
              %% in case some sucker rex'es 
              %% something that throws
              case catch apply(Mod, Fun, Args) of
              {'EXIT', _} = Exit -&gt;
                  {badrpc, Exit};
              Result -&gt;
                  Result
              end,
          RpcServer ! {self(), {reply, Reply}}
      end),
    {noreply, gb_trees:insert(Caller, To, S)}.

set_group_leader(Gleader) when is_pid(Gleader) -&gt; 
    group_leader(Gleader, self());
set_group_leader(user) -&gt; 
    %% For example, hidden C nodes doesn't want any I/O.
    Gleader = case whereis(user) of
          Pid when is_pid(Pid) -&gt; Pid;
          undefined -&gt; proxy_user()
          end,
    group_leader(Gleader, self()).
</code></pre>
<p>åœ¨<code>set_group_leader/1</code>ä¸­ï¼Œè¿˜èƒ½çœ‹åˆ°<code>user</code>çš„èº«å½±ã€‚å®˜æ–¹æ–‡æ¡£ä¸­å…³äº<code>user</code>çš„ä»‹ç»ï¼š</p>
<pre><code>MODULE SUMMARY
Standard I/O Server

DESCRIPTION
user is a server which responds to all the messages defined in the I/O interface. 
The code in user.erl can be used as a model for building alternative I/O servers.
</code></pre>
<p>æ‰€ä»¥ï¼Œuseræ˜¯Erlang/OTPä¸­é»˜è®¤çš„æ ‡å‡†i/oè¿›ç¨‹ï¼Œä¸çŸ¥é“io_requestæ€ä¹ˆå¤„ç†æ—¶ï¼Œå¾€useræ‰”åº”è¯¥ä¸ä¼šé”™å§ï¼Ÿ :)</p>
<p>-EOF-</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>æ›´æ–°äº 2014-09-20</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/erlang/">erlang</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">è¿”å›</a></span>&nbsp;|&nbsp;<span><a href="/">ä¸»é¡µ</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/posts/remote-and-local-call-in-erlang/" class="prev" rel="prev" title="å‡½æ•°è°ƒç”¨å’Œçƒ­æ›´æ–°"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>å‡½æ•°è°ƒç”¨å’Œçƒ­æ›´æ–°</a>
            <a href="/posts/may-be-a-escript-bug/" class="next" rel="next" title="escriptä¹‹è¯¡ç§˜">escriptä¹‹è¯¡ç§˜<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">ç”± <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.111.3">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="http://adelzhang.github.io" target="_blank">adelzhang</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="å›åˆ°é¡¶éƒ¨">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="æŸ¥çœ‹è¯„è®º">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":50},"comment":{}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
